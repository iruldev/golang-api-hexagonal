name: Nightly

on:
  schedule:
    - cron: '0 3 * * *'  # 3 AM UTC daily
  workflow_dispatch:  # Manual trigger

jobs:
  race-detection:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install dependencies
        run: go mod download

      # Story 2.4: Full race detection on all packages
      # This is compute-intensive, run nightly instead of on every PR
      - name: Full race detection
        run: go test -race -timeout 30m ./...

      # Notify team on failure via GitHub issue comment
      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const message = `## ‚ùå Nightly Race Detection Failed

            **Workflow:** ${context.workflow}
            **Run:** ${context.runNumber}
            **Commit:** ${context.sha.substring(0, 7)}

            [View Run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            `;

            // Create a new issue for visibility
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üèéÔ∏è Nightly Race Detection Failed',
              body: message,
              labels: ['ci-failure', 'race-condition']
            });

  integration-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install dependencies
        run: go mod download

      # Story 2.4: Integration tests with testcontainers
      # Requires Docker, run nightly for full coverage
      - name: Run integration tests
        run: go test -v -tags=integration ./...
