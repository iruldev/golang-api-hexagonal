# Mutation Testing Workflow
# 
# Runs mutation tests using Gremlins to verify test quality
# https://github.com/go-gremlins/gremlins
#
# Story 5.3: Mutation Testing with Gremlins
# NFR-MAINT-2: Mutation Score â‰¥60% mutations killed

name: Mutation Testing

on:
  schedule:
    # Weekly on Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      packages:
        description: 'Packages to mutate (default: domain + app layers)'
        required: false
        default: ''
      threshold:
        description: 'Mutation score threshold (0.0-1.0)'
        required: false
        default: '0.6'

jobs:
  mutation-test:
    name: Mutation Testing
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.5'
          cache: true

      - name: Download Dependencies
        run: go mod download

      - name: Install Gremlins
        run: go install github.com/go-gremlins/gremlins/cmd/gremlins@latest

      - name: Run Mutation Tests
        id: mutation
        run: |
          echo "ðŸ§Ÿ Running mutation tests..."
          gremlins unleash --config .gremlins.yaml --output json > mutation-report.json 2>&1 || true
          
          # Extract mutation score if available
          if [ -f mutation-report.json ]; then
            echo "mutation_report=true" >> $GITHUB_OUTPUT
          else
            echo "mutation_report=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true  # Non-blocking

      - name: Generate HTML Report
        if: always()
        run: |
          gremlins unleash --config .gremlins.yaml --output html 2>&1 || true
        continue-on-error: true

      - name: Upload Mutation Report (JSON)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mutation-report-json
          path: |
            mutation-report.json
            .gremlins/
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload Mutation Report (HTML)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mutation-report-html
          path: .gremlins/
          retention-days: 30
          if-no-files-found: ignore

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ§Ÿ Mutation Testing Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Threshold | 60% |" >> $GITHUB_STEP_SUMMARY
          echo "| Target Packages | internal/domain, internal/app |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š See uploaded artifacts for detailed report." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **Note:** This workflow is informational only and does not block CI." >> $GITHUB_STEP_SUMMARY
