# Story 1.2: Mock Generation with uber-go/mock

Status: done

## Story

As a **developer**,
I want centralized mock generation,
so that all mocks are consistent and in one place.

## Acceptance Criteria

1. **AC1:** `go.uber.org/mock` added to dependencies
2. **AC2:** `//go:generate` directives in port interfaces
3. **AC3:** All mocks generated to `internal/testutil/mocks/`
4. **AC4:** `make mocks` target generates all mocks
5. **AC5:** Mocks contain `Code generated by MockGen` marker

## Tasks / Subtasks

- [x] Task 1: Add uber-go/mock dependency (AC: #1)
  - [x] Run `go get go.uber.org/mock/mockgen@latest`
  - [x] Add mockgen to `tools/tools.go` (if exists) or create it
  - [x] Verify `mockgen --version` works
- [x] Task 2: Add go:generate directives to domain interfaces (AC: #2)
  - [x] Add `//go:generate mockgen` to `internal/domain/user.go` (UserRepository)
  - [x] Add `//go:generate mockgen` to `internal/domain/audit.go` (AuditEventRepository)
  - [x] Use `-destination` to `internal/testutil/mocks/`
- [x] Task 3: Create make mocks target (AC: #4)
  - [x] Add `mocks` target to Makefile
  - [x] Target runs `go generate ./internal/domain/...`
  - [x] Add `mocks` to `.PHONY`
- [x] Task 4: Generate mocks and verify (AC: #3, #5)
  - [x] Run `make mocks`
  - [x] Verify mocks appear in `internal/testutil/mocks/`
  - [x] Verify each mock contains `Code generated by MockGen` marker

## Dev Notes

### Architecture Compliance

Per `architecture.md` ADRs and patterns:
- **AD-002:** Mock Generation = `go:generate` near interfaces + Makefile aggregator
- **Pattern 2:** Mock Naming Convention = `Mock{Interface}` in `internal/testutil/mocks/`
- **Pattern 11:** Generated Code Conventions = MockGen marker required

### Interfaces to Mock

| Interface | File | Mock Output |
|-----------|------|-------------|
| `UserRepository` | `domain/user.go` | `mocks/user_repository_mock.go` |
| `AuditEventRepository` | `domain/audit.go` | `mocks/audit_event_repository_mock.go` |

### go:generate Directive Format

```go
// In domain/user.go, above UserRepository interface:
//go:generate mockgen -destination=../testutil/mocks/user_repository_mock.go -package=mocks github.com/iruldev/golang-api-hexagonal/internal/domain UserRepository
```

### Makefile Target

```makefile
.PHONY: mocks
mocks: ## Generate all mocks
	@echo "Generating mocks..."
	go generate ./internal/domain/...
	@echo "Mocks generated in internal/testutil/mocks/"
```

### Expected Mock Files

After running `make mocks`, expect files like:
- `internal/testutil/mocks/user_repository_mock.go`
- `internal/testutil/mocks/audit_event_repository_mock.go`
- (other mocks based on port interfaces found)

### CI Check Script (from architecture.md)

```bash
# scripts/check-mock-location.sh
#!/bin/bash
# Enforce all mocks in internal/testutil/mocks/
find . -name '*_mock.go' -not -path './internal/testutil/mocks/*' | grep -q . && \
  echo "ERROR: Mocks found outside internal/testutil/mocks/" && exit 1
```

### Testing Standards

- Run `go generate ./internal/domain/...` to regenerate
- Run `go build ./internal/testutil/mocks/...` to verify syntax
- Check mock files contain `Code generated by MockGen` header

### References

- [Source: _bmad-output/architecture.md#AD-002 Mock Generation Strategy]
- [Source: _bmad-output/architecture.md#Pattern 2 Mock Naming Convention]
- [Source: _bmad-output/architecture.md#Pattern 11 Generated Code Conventions]
- [Source: _bmad-output/epics.md#Story 1.2]
- [Source: _bmad-output/prd.md#FR5]

### Previous Story Learnings (Story 1.1)

- Created `internal/testutil/mocks/doc.go` as placeholder
- Directory structure already in place
- Use unexported constants for internal values

## Dev Agent Record

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled during implementation_

### Completion Notes List

_To be filled after implementation_

### File List

_Files created/modified during implementation:_
- [x] `go.mod` (add go.uber.org/mock)
- [x] `tools/tools.go` (add mockgen import)
- [x] `Makefile` (add mocks target)
- [x] `internal/*/port/*.go` (add go:generate directives)
- [x] `internal/testutil/mocks/*_mock.go` (generated)
