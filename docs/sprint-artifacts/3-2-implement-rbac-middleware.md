# Story 3.2: Implement RBAC Middleware

Status: Done

## Story

As a developer,
I want RequireRole() middleware,
So that I can restrict routes to specific roles.

## Acceptance Criteria

1. **Given** a route protected with `RequireRole("admin")`
   **When** a user without admin role accesses it
   **Then** 403 Forbidden is returned
   **And** the error code is `INSUFFICIENT_ROLE` (or similar UPPER_SNAKE code)
   **And** the response follows the standard Envelope format with trace_id

2. **Given** a route protected with `RequireRole("admin")`
   **When** a user WITH the "admin" role accesses it
   **Then** the request proceeds to the handler successfully

3. **Given** a route protected with `RequireAnyRole("editor", "admin")`
   **When** a user with "editor" role accesses it
   **Then** the request proceeds
   **When** a user with "viewer" role accesses it
   **Then** 403 Forbidden is returned

4. **Given** a request context without claims (e.g. AuthMiddleware failed or missing)
   **When** RBAC middleware runs
   **Then** it fails safe with 401 Unauthorized or 500 Internal Error (log error)

## Tasks / Subtasks

- [x] Task 1: Add RBAC-specific error codes to central registry (AC: #1)
  - [x] Add `FORBIDDEN` (generic) to `internal/domain/errors/codes.go`
  - [x] Add `INSUFFICIENT_ROLE` to `internal/domain/errors/codes.go`
  - [x] Add `INSUFFICIENT_PERMISSION` to `internal/domain/errors/codes.go`
  - [x] Update `allCodes` map
  - [x] Map these codes to HTTP 403 in `internal/interface/http/response/mapper.go`

- [x] Task 2: Implement Authorization Middleware (AC: #1, #2, #3, #4)
  - [x] Create `internal/interface/http/middleware/authorization.go` (naming note: architecture calls it 'rbac', but 'authorization' is clearer given 'authentication' exists)
  - [x] Implement `RequireRole(role string) func(http.Handler) http.Handler`
  - [x] Implement `RequireAnyRole(roles ...string) func(http.Handler) http.Handler`
  - [x] Implement `RequirePermission(perm string) func(http.Handler) http.Handler`
  - [x] Ensure middleware extracts user claims using `ctxutil.ClaimsFromContext`

- [x] Task 3: Testing & Verification
  - [x] Create `internal/interface/http/middleware/authorization_test.go`
  - [x] Test role matching logic (exact match)
  - [x] Test multiple roles logic (any match)
  - [x] Test missing claims handling
  - [x] Verify standard error envelope and traces

## Dev Notes

### Architecture Compliance

- **Middleware Order**: `AuthMiddleware` (Story 3.1) -> `RequireRole` (Story 3.2).
- **Layering**: Middleware belongs in `internal/interface/http/middleware`.
- **Dependencies**: Depends on `ctxutil` for claims retrieval.

### Previous Story Outcomes (Story 3.1)

- Use `ctxutil.ClaimsFromContext(ctx)` to access `ctxutil.Claims` struct.
- `Claims` struct has `Roles []string` and `Permissions []string`.
- Error codes must be defined in `internal/domain/errors/codes.go` and use UPPER_SNAKE.
- Response must use `response.ErrorEnvelope`.
- Logging: Use structured logging with `trace_id`.

### References

- [Source: docs/epics.md#Story 3.2](file:///Users/khoirulsetyonugroho/Development/go-workspace/src/github.com/iruldev/golang-api-hexagonal/docs/epics.md)
- [Source: docs/architecture.md#Security Architecture](file:///Users/khoirulsetyonugroho/Development/go-workspace/src/github.com/iruldev/golang-api-hexagonal/docs/architecture.md)
- [Source: internal/interface/http/middleware/auth.go](file:///Users/khoirulsetyonugroho/Development/go-workspace/src/github.com/iruldev/golang-api-hexagonal/internal/interface/http/middleware/auth.go)

## Dev Agent Record

### Context Reference
- Generated by Create Story Workflow.
- Epic: 3 (Authentication & Authorization).

### Agent Model Used
Antigravity

### File List
- `internal/domain/errors/codes.go`
- `internal/interface/http/response/mapper.go`
- `internal/interface/http/middleware/authorization.go`
- `internal/interface/http/middleware/authorization_test.go`
- `internal/interface/http/router.go`
- `internal/interface/http/middleware/rbac_example_test.go`
- `internal/interface/http/response/mapper_rbac_test.go`
- `internal/interface/http/admin/features_test.go`
- `internal/interface/http/admin/handler_test.go`

### Senior Developer Review (AI)
- **Date**: 2025-12-16
- **Result**: Approved (With Fixes)
- **Findings**:
  - **Fixed Medium**: Added missing negative test cases for `RequireAnyRole` and `RequirePermission` (missing claims).
  - **Fixed Medium**: Added assertions for `trace_id` in error responses.
  - **Fixed Medium**: Improved logging of role/permission slices using `observability.Any`.
  - **Fixed Low**: Refactored `trace_id` log key to public constant.
  - **Verdict**: Codebase is now robust and verifies all ACs with high confidence.
