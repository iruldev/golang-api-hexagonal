# Epic 5 Retrospective - Security & Authentication Foundation

**Date:** 2025-12-18  
**Epic:** Epic 5: Security & Authentication Foundation  
**Status:** ‚úÖ Complete  
**Facilitator:** Bob (Scrum Master)

---

## Epic Summary

| Metric | Value |
|--------|-------|
| Total Stories | 5 |
| Completed | 5/5 (100%) |
| FRs Covered | FR25-34 (10 FRs) |
| Test Coverage | 88-90% across middleware |

### Stories Delivered

| Story | Title | Coverage | Status |
|-------|-------|----------|--------|
| 5.1 | Implement Request Validation Middleware | 4 tests | ‚úÖ done |
| 5.2 | Implement JWT Authentication Middleware | 88.2% | ‚úÖ done |
| 5.3 | Implement Authorization and Role Checking | Fail-closed | ‚úÖ done |
| 5.4 | Implement Security Headers Middleware | 88.9% | ‚úÖ done |
| 5.5 | Implement Rate Limiting Middleware | 90.3% | ‚úÖ done |

---

## What Went Well ‚úÖ

### 1. Deterministic Time Injection (Story 5.2)
- JWT middleware menggunakan `now func() time.Time` parameter
- Injected time function untuk expiry validation
- Testing jadi reliable tanpa flaky time-dependent tests
- Pattern ini recommended dari Epic 4 retrospective ‚Üí **Implemented!**

### 2. AuthContextBridge Pattern (Story 5.3)
- Clean separation antara JWT claims (transport) dan AuthContext (app layer)
- `internal/transport/http/middleware/auth_bridge.go` bridges the gap
- Fail-closed authorization: nil authCtx ‚Üí 403 FORBIDDEN
- Sesuai dengan architectural constraint: authorization di app layer

### 3. Consistent Middleware Config Pattern
- Semua middleware terima config via constructor:
  - `BodyLimiter(maxBytes int64)`
  - `JWTAuth(secret []byte, now func() time.Time)`
  - `SecureHeaders(next http.Handler)`
  - `RateLimiter(cfg RateLimitConfig)`
- Pattern ini mudah di-test dan di-configure

### 4. HSTS Auto-Detection (Story 5.4)
- Deteksi HTTPS via multiple sources:
  - `r.TLS != nil` (direct TLS)
  - `X-Forwarded-Proto: https` (reverse proxy)
  - `HSTS_ENABLED` env toggle
- Case-insensitive parsing untuk proxy headers (AI review fix)

### 5. Per-User Rate Limiting (Story 5.5)
- Authenticated requests: key = user ID dari JWT claims
- Unauthenticated requests: key = client IP
- Sliding window algorithm via go-chi/httprate
- Configurable via `RATE_LIMIT_RPS` dan `TRUST_PROXY`

### 6. RFC 7807 Error Consistency
- Semua security errors menggunakan RFC 7807 format:
  - `CodeUnauthorized` ‚Üí HTTP 401
  - `CodeForbidden` ‚Üí HTTP 403
  - `CodeRequestTooLarge` ‚Üí HTTP 413
  - `CodeRateLimitExceeded` ‚Üí HTTP 429
- Centralized mapping di `contract/error.go`

---

## Challenges & Growth Areas ‚ö†Ô∏è

### 1. AI Review Iterations
- Beberapa stories memerlukan multiple review rounds:
  - Story 5.3: Fail-closed behavior di GetUserUseCase
  - Story 5.4: HSTS case-insensitive detection
  - Story 5.5: Config validation untuk RateLimitRPS
- **Learning:** AI code review catches edge cases yang terlewat

### 2. Working Tree Requirement untuk `make ci`
- `make ci` membutuhkan clean working tree
- Beberapa stories blocked pada full CI verification
- **Workaround:** Individual `make test` + `make lint` verification
- **Learning:** Commit/stash changes before running CI

### 3. Claims Context Location Decision
- Awalnya `ctxutil` di `internal/shared/ctxutil`
- Kemudian dipindah ke `internal/transport/http/ctxutil` untuk better scoping
- **Learning:** Context helpers yang transport-specific sebaiknya di transport layer

---

## Key Learnings üìö

1. **Time Injection is Essential** - Semua time-dependent logic (JWT exp, rate limit window) harus menggunakan injected time function. Pattern `now func() time.Time` sangat efektif.

2. **AuthContext Bridge Pattern** - Transport layer set claims, bridge middleware converts ke app.AuthContext. App layer hanya kenal AuthContext, tidak kenal JWT claims.

3. **Fail-Closed Authorization** - Jika tidak ada AuthContext, default adalah FORBIDDEN (403), bukan pass-through. Security by default.

4. **Middleware Ordering Matters** - Position sangat penting:
   ```
   SecureHeaders ‚Üí RequestID ‚Üí Tracing ‚Üí Metrics ‚Üí Logging ‚Üí RealIP ‚Üí BodyLimiter ‚Üí Recoverer
   Route Group: JWTAuth ‚Üí AuthContextBridge ‚Üí RateLimiter ‚Üí Handlers
   ```

5. **Environment-Based Feature Flags** - `JWT_ENABLED`, `HSTS_ENABLED`, `TRUST_PROXY` memungkinkan progressive rollout dan environment-specific config.

---

## Epic 4 Action Items Follow-Up

| # | Action Item | Status | Evidence |
|---|-------------|--------|----------|
| 1 | Document UserRoutes interface pattern | ‚è≥ Not Done | Deferred |
| 2 | Add integration test documentation | ‚è≥ Not Done | Deferred |
| 3 | **Consider Clock interface for JWT exp** | ‚úÖ Completed | Story 5.2 uses `now func()` |
| 4 | **Create middleware pattern guide** | ‚úÖ Completed | Consistent patterns in 5.1-5.5 |

**Action Item Success Rate:** 2/4 (50%) - Critical security items completed!

---

## Epic 6 Preparation

### Dependencies Confirmed Ready ‚úÖ

| Prerequisite | Status | Source |
|--------------|--------|--------|
| AuthContext for ActorID | ‚úÖ Ready | Story 5.3 AuthContextBridge |
| RequestID correlation | ‚úÖ Ready | Epic 2 RequestID middleware |
| Transaction pattern (Querier) | ‚úÖ Ready | Epic 4 repository pattern |
| Error codes (RFC 7807) | ‚úÖ Ready | Epic 4 contract/error.go |
| Claims extraction | ‚úÖ Ready | Story 5.2 ctxutil.GetClaims |

### Patterns Established for Epic 6

| Pattern | File | Ready |
|---------|------|-------|
| Domain entity with ID | `internal/domain/user.go` | ‚úÖ |
| Repository interface | `internal/domain/user.go` | ‚úÖ |
| PostgreSQL repository | `internal/infra/postgres/user_repo.go` | ‚úÖ |
| App layer service | `internal/app/user/*.go` | ‚úÖ |
| AuthContext extraction | `internal/app/auth.go` | ‚úÖ |
| Transaction (Querier) | `internal/infra/postgres/querier.go` | ‚úÖ |

### Technical Prerequisites for Epic 6

| Prerequisite | Status |
|--------------|--------|
| New migration for audit_events | ‚è≥ Story 6.2 |
| PII redaction service | ‚è≥ Story 6.3 |
| AuditEventRepository | ‚è≥ Story 6.2 |
| Transactional audit recording | ‚è≥ Story 6.4 |

---

## Action Items

| # | Action | Owner | Priority |
|---|--------|-------|----------|
| 1 | Document AuthContextBridge pattern in architecture guide | Dev Agent | Medium |
| 2 | Add security middleware ordering documentation | Dev Agent | Medium |
| 3 | Create PII field configuration guide before Story 6.3 | SM Agent | High |
| 4 | Ensure audit events use same TX as business operations | Dev Agent | High |

---

## Team Commitments

- ‚úÖ Use `now func() time.Time` for all time-dependent middleware
- ‚úÖ Use AuthContextBridge pattern for transport ‚Üí app auth context
- ‚úÖ Fail-closed authorization (no auth context = 403)
- ‚úÖ Consistent middleware config injection pattern
- ‚úÖ RFC 7807 for all error responses
- ‚úÖ Run `make test` + `make lint` before pushes

---

## Verification Commands

```bash
# Run local CI pipeline
make ci

# Run tests with coverage
make coverage

# Check lint with boundary rules
make lint

# Start infrastructure
make infra-up

# Test JWT auth (with valid token)
curl -X GET http://localhost:8080/api/v1/users \
  -H "Authorization: Bearer <valid-token>"

# Test rate limiting
for i in {1..110}; do curl -s -o /dev/null -w "%{http_code}\n" http://localhost:8080/api/v1/users; done
```

---

## Next Steps

1. **Mark Epic 5 as done** in sprint-status.yaml ‚úÖ
2. **Begin Epic 6** with Story 6.1 (Audit Event Domain Model)
3. **Create PII redaction configuration** for Story 6.3
4. **Design transactional audit pattern** for Story 6.4

---

**Retrospective Completed:** 2025-12-18  
**Next Epic:** Epic 6 - Audit Trail System
