package {{.ModuleName}}

import (
	"context"
	"testing"

	"github.com/google/uuid"
	"{{.ModulePath}}/internal/domain/{{.ModuleName}}"
)

// MockRepository is a mock implementation of the Repository interface.
type MockRepository struct {
	CreateFunc  func(ctx context.Context, entity *{{.ModuleName}}.{{.EntityName}}) error
	GetByIDFunc func(ctx context.Context, id uuid.UUID) (*{{.ModuleName}}.{{.EntityName}}, error)
	UpdateFunc  func(ctx context.Context, entity *{{.ModuleName}}.{{.EntityName}}) error
	DeleteFunc  func(ctx context.Context, id uuid.UUID) error
	ListFunc    func(ctx context.Context, limit, offset int) ([]*{{.ModuleName}}.{{.EntityName}}, error)
}

func (m *MockRepository) Create(ctx context.Context, entity *{{.ModuleName}}.{{.EntityName}}) error {
	if m.CreateFunc != nil {
		return m.CreateFunc(ctx, entity)
	}
	return nil
}

func (m *MockRepository) GetByID(ctx context.Context, id uuid.UUID) (*{{.ModuleName}}.{{.EntityName}}, error) {
	if m.GetByIDFunc != nil {
		return m.GetByIDFunc(ctx, id)
	}
	return nil, nil
}

func (m *MockRepository) Update(ctx context.Context, entity *{{.ModuleName}}.{{.EntityName}}) error {
	if m.UpdateFunc != nil {
		return m.UpdateFunc(ctx, entity)
	}
	return nil
}

func (m *MockRepository) Delete(ctx context.Context, id uuid.UUID) error {
	if m.DeleteFunc != nil {
		return m.DeleteFunc(ctx, id)
	}
	return nil
}

func (m *MockRepository) List(ctx context.Context, limit, offset int) ([]*{{.ModuleName}}.{{.EntityName}}, error) {
	if m.ListFunc != nil {
		return m.ListFunc(ctx, limit, offset)
	}
	return nil, nil
}

func TestUsecase_Create(t *testing.T) {
	tests := []struct {
		name      string
		setupRepo func() *MockRepository
		entity    *{{.ModuleName}}.{{.EntityName}}
		wantErr   bool
	}{
		{
			name: "success",
			setupRepo: func() *MockRepository {
				return &MockRepository{}
			},
			entity:  {{.ModuleName}}.New{{.EntityName}}(),
			wantErr: false,
		},
		{
			name: "validation error",
			setupRepo: func() *MockRepository {
				return &MockRepository{}
			},
			entity: func() *{{.ModuleName}}.{{.EntityName}} {
				e := {{.ModuleName}}.New{{.EntityName}}()
				e.ID = uuid.Nil
				return e
			}(),
			wantErr: true,
		},
		// TODO: Add more test cases
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			repo := tt.setupRepo()
			uc := NewUsecase(repo)

			err := uc.Create(context.Background(), tt.entity)

			if (err != nil) != tt.wantErr {
				t.Errorf("Create() error = %v, wantErr %v", err, tt.wantErr)
			}
		})
	}
}

func TestUsecase_GetByID(t *testing.T) {
	testID := uuid.New()
	expectedEntity := {{.ModuleName}}.New{{.EntityName}}()
	expectedEntity.ID = testID

	repo := &MockRepository{
		GetByIDFunc: func(ctx context.Context, id uuid.UUID) (*{{.ModuleName}}.{{.EntityName}}, error) {
			if id == testID {
				return expectedEntity, nil
			}
			return nil, {{.ModuleName}}.ErrNotFound
		},
	}

	uc := NewUsecase(repo)

	entity, err := uc.GetByID(context.Background(), testID)
	if err != nil {
		t.Errorf("unexpected error: %v", err)
	}
	if entity.ID != testID {
		t.Errorf("expected ID %s, got %s", testID, entity.ID)
	}
}
